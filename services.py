import base64
import json
import requests
from bs4 import BeautifulSoup
from openai import OpenAI
from config import settings
from models import AnalysisResult

class OpenAIService:
    def __init__(self):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        self.client = OpenAI(api_key=settings.api_key, base_url=settings.base_url)

    def _encode_image(self, image_path: str) -> str:
        """–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ GPT-Vision"""
        with open(image_path, "rb") as image_file:
            return base64.b64encode(image_file.read()).decode('utf-8')

    def analyze_text(self, text: str) -> AnalysisResult:
        """–ì–ª—É–±–æ–∫–∏–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –æ—Ü–µ–Ω–æ–∫"""
        prompt = f"""
        –¢—ã ‚Äî —Å—É—Ä–æ–≤—ã–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π —Ä–∞–∑–≤–µ–¥–∫–µ –≤ –º–µ–¥–∏—Ü–∏–Ω–µ. 
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞:
        {text}

        –¢–†–ï–ë–û–í–ê–ù–ò–Ø (–°–¢–†–û–ì–û):
        1. strengths: –ú–∏–Ω–∏–º—É–º 3-5 —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω (–æ—Ñ—Ñ–µ—Ä—ã, —Å–µ—Ä–≤–∏—Å, –¥–æ–≤–µ—Ä–∏–µ).
        2. weaknesses: –ú–∏–Ω–∏–º—É–º 3-5 —Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω (—á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–æ –ø–ª–æ—Ö–æ).
        3. technical_specs: –°–¢–†–û–ì–û –ø–ª–æ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å {{ "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–∑–Ω–∞—á–µ–Ω–∏–µ" }}. –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
        4. design_score: –í –¥–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–º –∞–Ω–∞–ª–∏–∑–µ —É—Å—Ç–∞–Ω–æ–≤–∏ 0 –∏–ª–∏ "N/A".
        5. market_potential: –î–∞–π –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 10 –ò –ö–†–ê–¢–ö–û–ï –ü–û–Ø–°–ù–ï–ù–ò–ï (–Ω–∞–ø—Ä–∏–º–µ—Ä: "8/10 - –æ—Ç–ª–∏—á–Ω—ã–µ —Ü–µ–Ω—ã, –Ω–æ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–∏—Ü–µ–Ω–∑–∏–∏"). 
        6. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –¥–µ–ª–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ.

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–°–¢–†–û–ì–û JSON):
        {{
            "company_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ",
            "product_category": "–∫–∞—Ç–µ–≥–æ—Ä–∏—è",
            "strengths": ["...", "...", "..."],
            "weaknesses": ["...", "...", "..."],
            "technical_specs": {{ "–ø–∞—Ä–∞–º–µ—Ç—Ä": "–∑–Ω–∞—á–µ–Ω–∏–µ" }},
            "design_score": "0",
            "market_potential": "–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ",
            "overall_strategy": "—Ä–µ–∑—é–º–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"
        }}
        """
        
        response = self.client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}],
            response_format={ "type": "json_object" }
        )
        return AnalysisResult.model_validate_json(response.choices[0].message.content)

    def analyze_image(self, image_path: str) -> AnalysisResult:
        """–£–ª—å—Ç—Ä–∞-—Ç–æ—á–Ω—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –∞—É–¥–∏—Ç —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π"""
        base64_image = self._encode_image(image_path)
        
        instruction = """
        –¢—ã ‚Äî –≤–µ–¥—É—â–∏–π —Å—Ç—Ä–∞—Ç–µ–≥ –≤ –∞–≥–µ–Ω—Ç—Å—Ç–≤–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–∞ –∏ –ø—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–µ—Å—Ç–∫–∏–π –∏ –ü–†–ê–í–î–ò–í–´–ô –∞—É–¥–∏—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.
        
        –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤—ã–¥—É–º—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã. –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ, —Ç—ã –æ–±—è–∑–∞–Ω —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞—Ç—å.
        
        –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –í–ò–ó–£–ê–õ–¨–ù–û–ô –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):
        1. –ö–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏ (CTA): –ò—â–∏ –ª—é–±—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é –¥–ª—è –∑–∞–∫–∞–∑–∞ (–∫–Ω–æ–ø–∫–∏, –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã/—Ç–µ–ª–µ–∂–∫–∏). –û–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ª—é–±–æ–≥–æ —Ü–≤–µ—Ç–∞ (–∑–µ–ª–µ–Ω—ã–π, —Å–∏–Ω–∏–π, –∫—Ä–∞—Å–Ω—ã–π –∏ –¥—Ä.) –∏ –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–π —Ç–µ–∫—Å—Ç ('–ö—É–ø–∏—Ç—å', '–í –∫–æ—Ä–∑–∏–Ω—É', '–ó–∞–∫–∞–∑–∞—Ç—å', 'üõí'). –ï—Å–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏ ‚Äî –ø—Ä–∏–∑–Ω–∞–π —ç—Ç–æ –∫–∞–∫ strength. –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –≤ weaknesses, —á—Ç–æ –∫–Ω–æ–ø–æ–∫ –Ω–µ—Ç, –µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–Ω—ã.
        2. –¶–µ–Ω—ã: –ï—Å–ª–∏ —Ü–µ–Ω—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã –≤–∏–¥–Ω—ã –∏ —á–µ—Ç–∫–æ —Ä–∞–∑–ª–∏—á–∏–º—ã ‚Äî —ç—Ç–æ strength.
        3. –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å: –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –ª–µ–≥–∫–æ, –Ω–µ –ø–∏—à–∏ –æ –ø–ª–æ—Ö–æ–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏. –ò—â–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–≤—è–∑—á–∏–≤—ã–µ –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏, –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞).
        4. –ö–æ–Ω—Ç–µ–Ω—Ç: –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫, —Ñ–∏–ª—å—Ç—Ä–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ª–æ–≥–æ—Ç–∏–ø–∞.
        
        –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£ (–°–¢–†–û–ì–û):
        1. company_name: –¢–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞. –ï—Å–ª–∏ –Ω–µ –≤–∏–¥–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏ '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä'.
        2. product_category: –ù–∏—à–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ù–µ–≤—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π').
        
        3. strengths (–º–∏–Ω–∏–º—É–º 4 –ø—É–Ω–∫—Ç–∞): –û–ø–∏—Å—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –†–ï–ê–õ–¨–ù–û –≤–∏–¥–∏—à—å. –ü—Ä–∏–º–µ—Ä: '–ù–∞–ª–∏—á–∏–µ –∞–∫—Ü–µ–Ω—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –∑–∞–∫–∞–∑–∞ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ', '–ß–µ—Ç–∫–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –±—Ä–µ–Ω–¥–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π', '–ù–∞–≥–ª—è–¥–Ω–∞—è —Å–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ü–µ–Ω–∞–º–∏'.
        
        4. weaknesses (–º–∏–Ω–∏–º—É–º 4 –ø—É–Ω–∫—Ç–∞): –ë—É–¥—å –ø—Ä–∏–¥–∏—Ä—á–∏–≤ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –¥–µ—Ç–∞–ª—è–º. –ü—Ä–∏–º–µ—Ä: '–í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ –º–µ—à–∞—é—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –æ—Å–º–æ—Ç—Ä—É —Ç–æ–≤–∞—Ä–∞', '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏', '–ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –ø—É—Å—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞'.
        
        5. technical_specs: –°–¢–†–û–ì–û –ü–õ–û–°–ö–ò–ô –°–õ–û–í–ê–†–¨ –≤ —Ñ–æ—Ä–º–∞—Ç–µ {"–ú–æ–¥–µ–ª—å": "–¶–µ–Ω–∞/–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞"}. –í—ã–ø–∏—à–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏. –ò—Å–ø—Ä–∞–≤–ª—è–π –æ–ø–µ—á–∞—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–°—Ç–µ—Ç–æ—Å–∫–æ–ø' –≤–º–µ—Å—Ç–æ '–°—Ç–µ—Ä–æ—Å–∫–æ–ø').
        
        6. design_score: –î–∞–π –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 10 –ò –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–Ø–°–ù–ï–ù–ò–ï –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –ª–æ–≥–∏–∫–∞ UX, —ç—Å—Ç–µ—Ç–∏–∫–∞).
           –ü—Ä–∏–º–µ—Ä: "8/10 (–ë–∞–ª–ª—ã —Å–Ω—è—Ç—ã –∑–∞ –Ω–∞–≤—è–∑—á–∏–≤—ã–µ –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏, –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º UX –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ)".
        
        7. market_potential: –î–∞–π –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 10 –ò –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–Ø–°–ù–ï–ù–ò–ï.
           –ü—Ä–∏–º–µ—Ä: "7/10 (–í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∑–∞ —Å—á–µ—Ç —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è)".
        
        8. overall_strategy: –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. 
           –ù–∞–ø–∏—à–∏ –ø–æ —à–∞–±–ª–æ–Ω—É: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è: [–õ–æ—É–∫–æ—Å—Ç–µ—Ä/–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π/–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä]. –§–æ–∫—É—Å –Ω–∞ [—Ü–µ–Ω–∞/–∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç/–±—Ä–µ–Ω–¥]. –û—Å–Ω–æ–≤–Ω–æ–π –±–∞—Ä—å–µ—Ä –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî [—á—Ç–æ –º–µ—à–∞–µ—Ç –∫—É–ø–∏—Ç—å]'.
        
        –Ø–∑—ã–∫: –†–£–°–°–ö–ò–ô. –§–æ—Ä–º–∞—Ç: JSON.
        """
        
        response = self.client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": instruction},
                        {
                            "type": "image_url",
                            "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
                        },
                    ],
                }
            ],
            response_format={ "type": "json_object" }
        )
        
        raw_content = response.choices[0].message.content
        return AnalysisResult.model_validate_json(raw_content)

    def analyze_site(self, url: str) -> AnalysisResult:
        """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ —Å–∞–π—Ç–∞"""
        raw_text = self._scrape_website(url)
        return self.analyze_text(raw_text)

    def _scrape_website(self, url: str) -> str:
        """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ —Å —Å–∞–π—Ç–∞"""
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()
            soup = BeautifulSoup(response.text, 'html.parser')
            # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å –ò–ò
            for element in soup(["script", "style", "nav", "footer"]):
                element.decompose()
            return soup.get_text(separator=" ")[:8000]
        except Exception as e:
            return f"Error: {str(e)}"

openai_service = OpenAIService()